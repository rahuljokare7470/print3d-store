{% extends "base.html" %}

{% block title %}Inquiry from {{ inquiry.name }} - Admin Panel - {{ config.BUSINESS_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header with Back Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/admin/inquiries" class="text-decoration-none text-muted me-2">
                <i class="fas fa-arrow-left"></i> Back to Inquiries
            </a>
            <h1 class="h2 mt-2">Customer Inquiry</h1>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="toggleStatusBtn" onclick="toggleReadStatus()">
                <i class="fas fa-envelope me-2"></i><span id="statusText">Mark as Read</span>
            </button>
            <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
                <i class="fas fa-trash me-2"></i>Delete
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Customer Information Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Customer Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted text-uppercase mb-2">Full Name</h6>
                            <p class="mb-3 h6">{{ inquiry.name }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted text-uppercase mb-2">Email Address</h6>
                            <p class="mb-3 h6">
                                <a href="mailto:{{ inquiry.email }}" class="text-decoration-none">{{ inquiry.email }}</a>
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted text-uppercase mb-2">Phone Number</h6>
                            <p class="mb-0 h6">
                                {% if inquiry.phone %}
                                <a href="tel:{{ inquiry.phone }}" class="text-decoration-none">{{ inquiry.phone }}</a>
                                {% else %}
                                <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted text-uppercase mb-2">Submitted Date</h6>
                            <p class="mb-0 h6">{{ inquiry.created_at.strftime('%d %B %Y, %I:%M %p') if inquiry.created_at else 'N/A' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inquiry Content Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0"><i class="fas fa-message me-2"></i>Inquiry Details</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-3">Subject</h6>
                    <h4 class="mb-4">{{ inquiry.subject }}</h4>

                    <h6 class="text-muted text-uppercase mb-3">Message</h6>
                    <div class="bg-light p-4 rounded border">
                        <p class="mb-0 text-break" style="white-space: pre-wrap;">{{ inquiry.message }}</p>
                    </div>
                </div>
            </div>

            <!-- Reply Via Email -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0"><i class="fas fa-reply me-2"></i>Reply</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Send a reply to this customer via email:</p>
                    <a href="mailto:{{ inquiry.email }}?subject=Re: {{ inquiry.subject }}" class="btn btn-primary w-100">
                        <i class="fas fa-envelope me-2"></i>Send Email Reply
                    </a>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0"><i class="fas fa-tag me-2"></i>Status</h5>
                </div>
                <div class="card-body">
                    {% if inquiry.is_read %}
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-envelope-open me-2"></i>
                        <strong>Read</strong>
                        <p class="mb-0 mt-2 small">This inquiry has been marked as read.</p>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-envelope me-2"></i>
                        <strong>Unread</strong>
                        <p class="mb-0 mt-2 small">This inquiry has not been read yet.</p>
                    </div>
                    {% endif %}
                    <button class="btn btn-outline-primary w-100" onclick="toggleReadStatus()">
                        <i class="fas fa-sync-alt me-2"></i>
                        <span id="toggleBtnText">{% if inquiry.is_read %}Mark as Unread{% else %}Mark as Read{% endif %}</span>
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="mailto:{{ inquiry.email }}" class="btn btn-outline-primary">
                            <i class="fas fa-envelope me-2"></i>Send Email
                        </a>
                        {% if inquiry.phone %}
                        <a href="tel:{{ inquiry.phone }}" class="btn btn-outline-primary">
                            <i class="fas fa-phone me-2"></i>Call Customer
                        </a>
                        {% endif %}
                        <a href="/admin/inquiries" class="btn btn-outline-secondary">
                            <i class="fas fa-list me-2"></i>Back to List
                        </a>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card border-0 shadow-sm border-danger">
                <div class="card-header bg-danger bg-opacity-10 border-danger">
                    <h5 class="mb-0 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3 small">Permanently delete this inquiry. This action cannot be undone.</p>
                    <button class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
                        <i class="fas fa-trash me-2"></i>Delete Inquiry
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-danger">
                <h5 class="modal-title" id="deleteConfirmLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Are you sure you want to delete this inquiry from <strong>{{ inquiry.name }}</strong>?</p>
                <p class="text-muted mb-0 small">This action cannot be undone and the inquiry will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Inquiry</button>
            </div>
        </div>
    </div>
</div>

<script>
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const inquiryId = {{ inquiry.id }};

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        fetch(`/admin/inquiries/${inquiryId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                showSuccessAlert('Inquiry deleted successfully. Redirecting...');
                setTimeout(() => {
                    window.location.href = '/admin/inquiries';
                }, 1500);
            } else {
                showErrorAlert('Failed to delete inquiry');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorAlert('An error occurred while deleting the inquiry');
        });
    });

    function toggleReadStatus() {
        const currentStatus = {{ 'true' if inquiry.is_read else 'false' }};
        const newStatus = !currentStatus;

        fetch(`/admin/inquiries/${inquiryId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ is_read: newStatus })
        })
        .then(response => {
            if (response.ok) {
                // Update UI
                const statusAlert = document.querySelector('.alert');
                const statusText = document.getElementById('statusText');
                const toggleBtnText = document.getElementById('toggleBtnText');

                if (newStatus) {
                    statusAlert.classList.remove('alert-warning');
                    statusAlert.classList.add('alert-success');
                    statusAlert.innerHTML = `
                        <i class="fas fa-envelope-open me-2"></i>
                        <strong>Read</strong>
                        <p class="mb-0 mt-2 small">This inquiry has been marked as read.</p>
                    `;
                    statusText.textContent = 'Mark as Unread';
                    toggleBtnText.textContent = 'Mark as Unread';
                } else {
                    statusAlert.classList.remove('alert-success');
                    statusAlert.classList.add('alert-warning');
                    statusAlert.innerHTML = `
                        <i class="fas fa-envelope me-2"></i>
                        <strong>Unread</strong>
                        <p class="mb-0 mt-2 small">This inquiry has not been read yet.</p>
                    `;
                    statusText.textContent = 'Mark as Read';
                    toggleBtnText.textContent = 'Mark as Read';
                }
                showSuccessAlert('Status updated successfully');
            } else {
                showErrorAlert('Failed to update status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorAlert('An error occurred while updating the status');
        });
    }

    function showSuccessAlert(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alert.style.zIndex = '9999';
        alert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }

    function showErrorAlert(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alert.style.zIndex = '9999';
        alert.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }
</script>

<style>
    .bg-opacity-10 {
        opacity: 0.1;
    }

    .text-break {
        word-break: break-word;
    }
</style>
{% endblock %}
