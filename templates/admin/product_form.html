{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            {% if product %}
                <h1 class="h3 fw-bold text-dark">Edit Product</h1>
                <p class="text-muted">Update product information</p>
            {% else %}
                <h1 class="h3 fw-bold text-dark">Add New Product</h1>
                <p class="text-muted">Create a new product in your catalog</p>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('admin.products') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Products
            </a>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="mb-0 fw-bold"><i class="fas fa-info-circle text-primary me-2"></i>Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="name" class="form-label fw-600">Product Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Enter product name"
                                       value="{{ product.name if product else '' }}" required>
                                <small class="form-text text-muted">What is your product called?</small>
                            </div>
                            <div class="col-md-6">
                                <label for="slug" class="form-label fw-600">Slug <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="slug" name="slug" placeholder="auto-generated-from-name"
                                       value="{{ product.slug if product else '' }}" required>
                                <small class="form-text text-muted">URL-friendly name (auto-generated)</small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="category_id" class="form-label fw-600">Category <span class="text-danger">*</span></label>
                                <select class="form-select" id="category_id" name="category_id" required>
                                    <option value="">Select a category</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}" {% if product and product.category_id == category.id %}selected{% endif %}>
                                            {{ category.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="price" class="form-label fw-600">Price (₹) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="price" name="price" placeholder="0.00" step="0.01"
                                       value="{{ product.price if product else '' }}" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="original_price" class="form-label fw-600">Original Price (₹)</label>
                                <input type="number" class="form-control" id="original_price" name="original_price" placeholder="0.00" step="0.01"
                                       value="{{ product.original_price if product else '' }}">
                                <small class="form-text text-muted">Optional: For showing discounts</small>
                            </div>
                            <div class="col-md-6">
                                <label for="stock_status" class="form-label fw-600">Stock Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="stock_status" name="stock_status" required>
                                    <option value="">Select status</option>
                                    <option value="in_stock" {% if product and product.stock_status == 'in_stock' %}selected{% endif %}>In Stock</option>
                                    <option value="out_of_stock" {% if product and product.stock_status == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                                    <option value="pre_order" {% if product and product.stock_status == 'pre_order' %}selected{% endif %}>Pre-order</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="short_description" class="form-label fw-600">Short Description</label>
                            <input type="text" class="form-control" id="short_description" name="short_description" placeholder="Brief product summary"
                                   value="{{ product.short_description if product else '' }}">
                            <small class="form-text text-muted">Max 160 characters - appears in search results</small>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label fw-600">Full Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="description" name="description" rows="6" placeholder="Enter detailed product description" required>{{ product.description if product else '' }}</textarea>
                            <small class="form-text text-muted">Detailed information about your product</small>
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="mb-0 fw-bold"><i class="fas fa-images text-primary me-2"></i>Product Images</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for i in range(1, 5) %}
                            <div class="col-md-6 mb-4">
                                <label for="image{{ i }}" class="form-label fw-600">Image {{ i }}</label>
                                <div class="mb-2" id="preview{{ i }}" style="display: {% if product and product['image' + str(i)] %}block{% else %}none{% endif %};">
                                    {% if product and product['image' + str(i)] %}
                                        <img src="{{ product['image' + str(i)] }}" alt="Image {{ i }}" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                        <p class="mt-2 text-muted small">Current image</p>
                                    {% endif %}
                                </div>
                                <input type="file" class="form-control image-input" id="image{{ i }}" name="image{{ i }}" accept="image/*">
                                <small class="form-text text-muted">JPG, PNG (Max 2MB)</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- SEO Settings -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="mb-0 fw-bold"><i class="fas fa-search text-primary me-2"></i>SEO Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="meta_title" class="form-label fw-600">Meta Title</label>
                            <input type="text" class="form-control" id="meta_title" name="meta_title" placeholder="Page title for search engines"
                                   value="{{ product.meta_title if product else '' }}" maxlength="60">
                            <small class="form-text text-muted">Max 60 characters</small>
                        </div>

                        <div class="mb-3">
                            <label for="meta_description" class="form-label fw-600">Meta Description</label>
                            <textarea class="form-control" id="meta_description" name="meta_description" rows="3" placeholder="Description for search engines" maxlength="160">{{ product.meta_description if product else '' }}</textarea>
                            <small class="form-text text-muted">Max 160 characters</small>
                        </div>

                        <div class="mb-3">
                            <label for="tags" class="form-label fw-600">Tags</label>
                            <input type="text" class="form-control" id="tags" name="tags" placeholder="Separate tags with commas"
                                   value="{{ product.tags if product else '' }}">
                            <small class="form-text text-muted">E.g., 3D printing, prototyping, manufacturing</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Status -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="mb-0 fw-bold"><i class="fas fa-toggle-on text-primary me-2"></i>Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" value="on"
                                   {% if product and product.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">Active</label>
                            <small class="form-text text-muted d-block">Product is visible on store</small>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured" value="on"
                                   {% if product and product.is_featured %}checked{% endif %}>
                            <label class="form-check-label" for="is_featured">Featured</label>
                            <small class="form-text text-muted d-block">Show on homepage</small>
                        </div>
                    </div>
                </div>

                <!-- Stock Management -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="mb-0 fw-bold"><i class="fas fa-warehouse text-primary me-2"></i>Stock</label>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="stock" class="form-label fw-600">Stock Quantity</label>
                            <input type="number" class="form-control" id="stock" name="stock" placeholder="0"
                                   value="{{ product.stock if product else '' }}" min="0">
                        </div>

                        <div class="alert alert-info" style="font-size: 13px;">
                            <i class="fas fa-info-circle me-2"></i>
                            Quantity needs to be updated when stock changes
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>
                        {% if product %}Save Changes{% else %}Add Product{% endif %}
                    </button>
                    <a href="{{ url_for('admin.products') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>

                {% if product %}
                <div class="alert alert-warning mt-3" style="font-size: 12px;">
                    <i class="fas fa-eye-slash me-2"></i>
                    Product created: {{ product.created_at.strftime('%d %b %Y, %H:%M') if product.created_at else 'N/A' }}
                </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<style>
    .fw-600 {
        font-weight: 600 !important;
    }

    .form-label {
        font-size: 14px;
        color: #2c3e50;
    }

    .form-control,
    .form-select {
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 10px 12px;
        font-size: 14px;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.15);
    }

    .form-text {
        font-size: 12px;
    }

    .text-danger {
        color: #e74c3c !important;
    }

    .img-thumbnail {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 8px;
    }

    .alert {
        border-radius: 6px;
        border: 1px solid;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
    }

    .form-check-input {
        width: 1.25em;
        height: 1.25em;
        margin-top: 0.25em;
        border: 2px solid #dee2e6;
        cursor: pointer;
    }

    .form-check-input:checked {
        background-color: #3498db;
        border-color: #3498db;
    }

    .form-check-label {
        margin-left: 8px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-lg {
        padding: 12px 20px;
        font-weight: 600;
        border-radius: 6px;
        font-size: 15px;
    }

    .btn-primary:hover {
        background-color: #2980b9;
    }
</style>

<script>
    // Auto-generate slug from name
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');
    const isEditMode = {{ 'true' if product else 'false' }};

    function generateSlug(name) {
        return name
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    if (!isEditMode) {
        nameInput.addEventListener('input', function() {
            if (!slugInput.value || slugInput.dataset.autoGenerated !== 'false') {
                slugInput.value = generateSlug(this.value);
                slugInput.dataset.autoGenerated = 'true';
            }
        });
    }

    // Allow manual slug editing
    slugInput.addEventListener('focus', function() {
        this.dataset.autoGenerated = 'false';
    });

    // Image preview
    document.querySelectorAll('.image-input').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageNum = this.id.replace('image', '');
                    const previewDiv = document.getElementById('preview' + imageNum);
                    previewDiv.innerHTML = `<img src="${event.target.result}" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;"><p class="mt-2 text-muted small">New image selected</p>`;
                    previewDiv.style.display = 'block';
                }.bind(this);
                reader.readAsDataURL(file);
            }
        });
    });

    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    }, false);
</script>
{% endblock %}
